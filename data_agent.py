# data_agent.pyï¼ˆæ›´æ–°ç‰ˆï¼‰
import json
import subprocess
import sys
import tempfile
import os
import re
from llm import call_llm
from config import CURRENT_TEST_CASE

def clean_code_output(text: str) -> str:
    match = re.search(r"```(?:python)?\s*\n(.*?)\n```", text, re.DOTALL | re.IGNORECASE)
    if match:
        return match.group(1).strip()
    return text.strip()

def generate_paper_data():
    prompt_path = f"test_cases/{CURRENT_TEST_CASE}/data_prompt.txt"
    if not os.path.exists(prompt_path):
        raise FileNotFoundError(f"ç¼ºå°‘ data_prompt.txt: {prompt_path}")
    
    with open(prompt_path, "r", encoding="utf-8") as f:
        prompt = f.read()
    
    print(f"ğŸ§  Data Agent æ­£åœ¨ä¸º '{CURRENT_TEST_CASE}' ç”Ÿæˆæ•°æ®æŠ“å–è„šæœ¬...")
    raw_code = call_llm(prompt)
    code = clean_code_output(raw_code)
    
    # âœ… æ–°å¢ï¼šä¿å­˜ç”Ÿæˆçš„è„šæœ¬åˆ° outputs/
    generated_script_path = "outputs/generated_data_scraper.py"
    with open(generated_script_path, "w", encoding="utf-8") as f:
        f.write("# -*- coding: utf-8 -*-\n")
        f.write("# This script was auto-generated by Data Agent based on data_prompt.txt\n")
        f.write(code)
    print(f"ğŸ’¾ ç”Ÿæˆçš„çˆ¬è™«è„šæœ¬å·²ä¿å­˜: {generated_script_path}")
    
    # ä½¿ç”¨è¯¥è„šæœ¬æ‰§è¡Œ
    try:
        print("ğŸ•·ï¸ æ­£åœ¨æ‰§è¡Œç”Ÿæˆçš„çˆ¬è™«è„šæœ¬...")
        result = subprocess.run(
            [sys.executable, generated_script_path],
            capture_output=True,
            text=True,
            timeout=60,
            env={**os.environ, 'PYTHONIOENCODING': 'utf-8'}
        )
        
        if result.returncode != 0:
            print(f"âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥:\n{result.stderr}")
            raise RuntimeError(f"Data Agent ç”Ÿæˆçš„è„šæœ¬æ‰§è¡Œå¤±è´¥ (test case: {CURRENT_TEST_CASE})")
        
        # è§£æ JSON è¾“å‡º
        data = json.loads(result.stdout.strip())
        output_path = "outputs/data.json"
        with open(output_path, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        print(f"âœ… çœŸå®æ•°æ®å·²ä¿å­˜: {output_path}")
            
    except json.JSONDecodeError as e:
        print(f"âŒ JSON è§£æå¤±è´¥:\n{result.stdout[:500]}...")
        raise RuntimeError(f"Data Agent è¾“å‡ºéæœ‰æ•ˆ JSON: {e}")